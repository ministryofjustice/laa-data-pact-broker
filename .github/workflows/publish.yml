name: Deploy

on: [push]

jobs:
  deploy:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Authenticate to the cluster
        uses: ./.github/actions/authenticate-cluster
        with:
          kube_cluster: ${{ secrets.KUBE_CLUSTER }}
          kube_cert: ${{ secrets.KUBE_CERT }}
          kube_token: ${{ secrets.KUBE_TOKEN }}
          kube_namespace: ${{ secrets.KUBE_NAMESPACE }}
      - name: Make deploy.sh executable
        run: chmod +x ./deploy.sh
      - name: Deploy
        run: ./deploy.sh
  apply_webhooks:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Authenticate to the cluster
        uses: ./.github/actions/authenticate-cluster
        with:
          kube_cluster: ${{ secrets.KUBE_CLUSTER }}
          kube_cert: ${{ secrets.KUBE_CERT }}
          kube_token: ${{ secrets.KUBE_TOKEN }}
          kube_namespace: ${{ secrets.KUBE_NAMESPACE }}
      - name: Make create-webhooks.sh executable
        run: chmod +x ./seed/create-webhooks.sh
      - name: Apply webhooks
        env:
          NAMESPACE: ${{ secrets.KUBE_NAMESPACE}}
          GITHUB_ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN}}
          GH_PAT_ACCESS_TOKEN: ${{ secrets.GH_PAT_ACCESS_TOKEN}}
        run: ./create-webhooks.sh
        working-directory: ./seed
