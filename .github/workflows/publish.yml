name: Deploy

on: [push]

jobs:
  deploy:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Authenticate to the cluster
        uses: ./.github/actions/authenticate-cluster
      - name: Make deploy.sh executable
        run: chmod +x ./deploy.sh
      - name: Deploy
        run: ./deploy.sh
  apply_webhooks:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Authenticate to the cluster
        uses: ./.github/actions/authenticate-cluster
      - name: Make create-webhooks.sh executable
        run: chmod +x ./seed/create-webhooks.sh
      - name: Apply webhooks
        env:
          NAMESPACE: ${{ secrets.KUBE_NAMESPACE}}
          GITHUB_ACCESS_TOKEN: "TODO"
        run: ./create-webhooks.sh
        working-directory: ./seed
